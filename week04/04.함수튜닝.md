# ****Chapter 04 "함수 튜닝"****

---

- 학습 내용
    1. 강력한 기능을 가지고 있지만 널리 사용되지 못하는 분석 함수를 이용한 튜닝 기법
    2. 적절한 사용법을 적용하지 않아 DBMS 부하의 주원인이 되는 사용자 정의함수 튜닝 기법

## 4.1 분석 함수 튜닝

### 4.1.1 집계 함수의 한계

- 집계함수 - SUM(), AVG(), COUNT()
- 결과 행의 건수를 보장하지 않는다.

  = > SQL 결과가 N개 행 이라면, 집계함수를 사용함으로써 결과행은 N개보다 적어진다.


```sql
SELECT SUM(SAL)           AS "연봉합계"
     , ROUND(AVG(SAL), 2) AS "연봉편균"
     , COUNT(*)           AS "건수"
FROM   EMP;
```

- 위 쿼리에서 EMP 테이블엔 14개의 행이 있지만, 집계 함수를 사용하면 결과 건수는 1건이다.
- 연봉합계, 연봉평균, 총 사원수를 뽑는 것이 목적이였다면 최상의 SQL 문이지만 집계 내역을 뽑으면서 사원에 대한 정보도 같이 보고싶다면 집계함수가 아닌 분석 함수가 적합

### 4.1.2 분석 함수의 유용성

- 분석함수 - WHERE 절을 통해 나온 행들을 대상으로 다양한 집계나 통계를 구할 때 사용하는 함수
- 분석 함수를 통해 다양한 통계와 소계를 구할 수 있음

```sql
SELECT  EMPNO
      , ENAME
      , JOB
      , SAL
      , DEPTNO
      , SUM(SAL) OVER()           AS "연봉합계"
      , ROUND(AVG(SAL) OVER(), 2) AS "연봉편균"
      , COUNT(*) OVEOR()          AS "건수"
FROM    EMP
```

### 4.1.3 분석 함수 튜닝

- 분석 함수를 튜닝함으로써 동일 테이블의 반복 스캔 또는 조인을 생략하고 간단하게 결과 추출 가능

### 4.1.4 주요 분석 함수

1. RANK
2. ROW_NUMBER
3. SUM
4. MAX
5. AVG

**실습 4-1 RANK 함수를 이용하여 반복적인 테이블 스캔 제거하기**

**실습 4-2 SUM 함수를 이용하여 반복적인 테이블 스캔 제거하기**

---

## 4.2 사용자 정의 함수 튜닝

### 4.2.1 사용자 정의 함수

- 사용자가 정의해놓고 필요 시 호출하여 사용하는 함수

## 

### 4.2.2 사용자 정의 함수의 재귀 호출 부하

- 오라클엔 내장함수, 사용자 정의 함수가 있음
- 내장 함수
    - NVL, DECODE
    - DBMS 엔진 내에 네이티브 코드로 컴파일된 상태로 존재하기 때문에 빠른 속도 보장
- 사용자 정의 함수
    - 오라클 내에 존재하는 PL/SQL 가상 머신 내에서 구동되어 내장 함수보다 컨텍스트 스위칭 부하가 발생
    - 이러한 부하를 재귀 호출 부하라고 함

### 4.2.3 사용자 정의 함수 튜닝

- 기본적으로 사용자 정의 함수를 사용하지 않아야 하지만, 사용 시 튜닝을 진행하여 재귀 호출 부하를 최소화 하도록 하자.

**실습 4-3 SUM 함수를 이용하여 반복적인 테이블 스캔 제거하기**